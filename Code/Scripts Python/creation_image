import matplotlib.pyplot as plt
from fonctions_communes_et_parametres import *

def get_derniere_heure(fichier):
  """
  Renvoie un tableau de tableaux les sous-tableaux les lignes de fichier passé en argument. Cela prend la derniere heure.
  """
  tableau = fichier.readlines()[-31:-1]
  fichier.seek(0, 0)
  nouveau_tableau = []
  for i in range(len(tableau)):
    ligne = tableau[i][:-3].split(",")
    nouveau_tableau.append(ligne)
  return nouveau_tableau

def get_date_heure(fichier):
    tableau = fichier.readlines()[-2:-1]
    ligne = tableau[0]
    ligne = ligne.split(",")
    date = ligne[0]
    heure = ligne[1]
    fichier.seek(0, 0)
    return date + " | " + heure

def get_ordonnee(num_colonne, fichier):
    ordonnees = []
    tableau = get_derniere_heure(fichier)
    for ligne in range(30):
      valeur = tableau[ligne][num_colonne]
      #Remplace les virgules par des points pour pouvoir les convertir en float
      valeur = valeur.replace(",", ".")
      valeur = float(valeur)
      ordonnees.append(valeur)
    return ordonnees

def get_image(minimum, premier_palier, deuxieme_palier, maximum, num_colonne, titre, fichier, inverser, **kargs):
    parametres = {
        "minimum" : minimum,
        "premier_palier" : premier_palier,
        "deuxieme_palier" : deuxieme_palier,
        "maximum" : maximum,
        "num_colonne" : num_colonne,
        "titre" : titre,
        "couleur_premiere_zone" : "#85C58C",
        "couleur_deuxieme_zone" : "#DCDD78",
        "couleur_troisieme_zone" : "#FF6961",
        "couleur_ecriture" : "#BBE1FA",
        "couleur_trait" : "black",
        "alpha" : 1,
        "inverser" : inverser,
        "nom_axe_y" : None
    }
    #Modifie les paramtres par ceux passés en arguments optionnels
    for cle, valeur in kargs.items():
        #Lève une erreur si le nom du paramètre n'existe pas
        if cle in parametres.keys():
            parametres[cle] = valeur
        else:
            raise ValueError("mauvais nom de variable passé en argument")

    abscisse = [i for i in range(-60, 0, 2)]
    ordonnees = get_ordonnee(parametres["num_colonne"], fichier)
    #Inverse les valeur si besoin
    if parametres["inverser"]:
        ordonnees = [parametres["maximum"] - element for element in ordonnees]
    #Dessine le trait des valeurs
    plt.plot(abscisse, ordonnees, color=parametres["couleur_trait"])
    #Dessine les trois zones en fond
    plt.axhspan(parametres["minimum"], parametres["premier_palier"], facecolor=parametres["couleur_premiere_zone"], alpha=parametres["alpha"])
    plt.axhspan(parametres["premier_palier"], parametres["deuxieme_palier"], facecolor=parametres["couleur_deuxieme_zone"], alpha=parametres["alpha"])
    plt.axhspan(parametres["deuxieme_palier"], parametres["maximum"], facecolor=parametres["couleur_troisieme_zone"], alpha=parametres["alpha"])
    #Ajoute le titre
    titre_image = parametres["titre"] + "\n" + get_date_heure(fichier)
    plt.title(titre_image, color=parametres["couleur_ecriture"])
    #Modifie la couleur des axes
    plt.xticks(color=parametres["couleur_ecriture"])
    plt.yticks(color=parametres["couleur_ecriture"])
    #Ajoute le nom des axes. L'axe y n'a pas de noms par défaut.
    plt.xlabel("Minutes", color=parametres["couleur_ecriture"])
    if parametres["nom_axe_y"] != None:
        plt.ylabel(parametres["nom_axe_y"], color=parametres["couleur_ecriture"])
    #Enregistre le fichier
    nom_fichier = "../Documents/" + parametres["titre"] + ".png"
    plt.savefig(nom_fichier, transparent=True)
    #Réinitialise le graphique pour le prochain coup
    plt.cla()

def lancer():
    #Securite
    #S'il n'y a pas assez de lignes, on arrete tout (30 + 1 de descripteurs)
    if nombre_lignes(nom_fichier_csv_serveur) < 32:
        print("Image : valeurs d'entrées insuffisantes")
        ecrire_erreur("Image : valeurs d'entrés insuffisantes")
        return

    fichier = open(nom_fichier_csv_serveur, "r")
    for element in seuils:
        get_image(element["minimum"], element["premier_seuil"], element["deuxieme_seuil"], element["maximum"], element["numero_colonne_valeur"], element["nom"], fichier, element["inverser_image"])
    fichier.close()
