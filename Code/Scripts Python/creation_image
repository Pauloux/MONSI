import time
import matplotlib.pyplot as plt

nom_fichier_logs = "../Documents/logs.txt"
nom_fichier_erreurs = "../Documents/erreurs.txt"
nom_fichier_csv_serveur = "../Documents/csv_serveur.csv"

def get_heure():
    return time.strftime("%H:%M:%S", time.localtime())

def get_temps():
    return time.time()

def ecrire_logs(ligne):
    fichier = open(nom_fichier_logs, "a")
    ligne = get_heure() + " " + ligne + "\n"
    fichier.write(ligne)
    fichier.close()

def ecrire_erreur(ligne):
    fichier = open(nom_fichier_erreurs, "a")
    ligne = get_heure() + " " + ligne + "\n"
    fichier.write(ligne)
    fichier.close()

def fichier_existe(nom_fichier):
    try:
        fichier = open(nom_fichier, "r")
        fichier.close()
        return True
    except IOError as message_erreur:
        return False

def clear_fichier(nom_fichier):
    fichier = open(nom_fichier, "w")
    fichier.close()

#Création des fichiers logs et erreur s'ils n'existent pas
if not fichier_existe(nom_fichier_logs) :
    fichier_logs = open(nom_fichier_logs, "x")
    fichier_logs.close()
if not fichier_existe(nom_fichier_erreurs) :
    fichier_erreurs = open(nom_fichier_erreurs, "x")
    fichier_erreurs.close()
#Remise a zéro des fichiers de logs et d'erreurs
clear_fichier(nom_fichier_logs)
clear_fichier(nom_fichier_erreurs)

def get_derniere_heure(fichier):
  """
  Renvoie un tableau de tableaux les sous-tableaux les lignes de fichier passé en argument. Cela prend la derniere heure.
  """
  tableau = fichier.readlines()[-31:-1]
  fichier.seek(0, 0)
  nouveau_tableau = []
  for i in range(len(tableau)):
    ligne = tableau[i][:-3].split(",")
    nouveau_tableau.append(ligne)
  #Securité
  while len(nouveau_tableau) < 30:
    nouveau_tableau.append("Fausse ligne")
    print("Image : Fausse ligne ajoutée")
    ecrire_logs("Image : Fausse ligne ajoutée")
    ecrire_erreur("Image : Fausse ligne ajoutée")
  return nouveau_tableau

def get_date_heure(fichier):
    tableau = fichier.readlines()[-2:-1]
    ligne = tableau[0]
    ligne = ligne.split(",")
    date = ligne[0]
    heure = ligne[1]
    fichier.seek(0, 0)
    return date + " | " + heure

def get_ordonnee(num_colonne, fichier):
    ordonnees = []
    tableau = get_derniere_heure(fichier)
    for ligne in range(30):
      valeur = tableau[ligne][num_colonne]
      #Remplace les virgules par des points pour pouvoir les convertir en float
      valeur = valeur.replace(",", ".")
      valeur = float(valeur)
      ordonnees.append(valeur)
    return ordonnees

def get_image(minimum, premier_palier, deuxieme_palier, maximum, num_colonne, titre, fichier,  **kargs):
    parametres = {
        "minimum" : minimum,
        "premier_palier" : premier_palier,
        "deuxieme_palier" : deuxieme_palier,
        "maximum" : maximum,
        "num_colonne" : num_colonne,
        "titre" : titre,
        "couleur_premiere_zone" : "#85C58C",
        "couleur_deuxieme_zone" : "#DCDD78",
        "couleur_troisieme_zone" : "#FF6961",
        "couleur_ecriture" : "#BBE1FA",
        "couleur_trait" : "black",
        "alpha" : 1,
        "inverser" : False,
        "nom_axe_y" : None
    }
    #Modifie les paramtres par ceux passés en arguments optionnels
    for cle, valeur in kargs.items():
        #Lève une erreur si le nom du paramètre n'existe pas
        if cle in parametres.keys():
            parametres[cle] = valeur
        else:
            raise ValueError("mauvais nom de variable passé en argument")

    abscisse = [i for i in range(-60, 0, 2)]
    ordonnees = get_ordonnee(parametres["num_colonne"], fichier)
    #Inverse les valeur si besoin
    if parametres["inverser"]:
        ordonnees = [parametres["maximum"] - element for element in ordonnees]
    #Dessine le trait des valeurs
    plt.plot(abscisse, ordonnees, color=parametres["couleur_trait"])
    #Dessine les trois zones en fond
    plt.axhspan(parametres["minimum"], parametres["premier_palier"], facecolor=parametres["couleur_premiere_zone"], alpha=parametres["alpha"])
    plt.axhspan(parametres["premier_palier"], parametres["deuxieme_palier"], facecolor=parametres["couleur_deuxieme_zone"], alpha=parametres["alpha"])
    plt.axhspan(parametres["deuxieme_palier"], parametres["maximum"], facecolor=parametres["couleur_troisieme_zone"], alpha=parametres["alpha"])
    #Ajoute le titre
    titre_image = parametres["titre"] + "\n" + get_date_heure(fichier)
    plt.title(titre_image, color=parametres["couleur_ecriture"])
    #Modifie la couleur des axes
    plt.xticks(color=parametres["couleur_ecriture"])
    plt.yticks(color=parametres["couleur_ecriture"])
    #Ajoute le nom des axes. L'axe y n'a pas de noms par défaut.
    plt.xlabel("Minutes", color=parametres["couleur_ecriture"])
    if parametres["nom_axe_y"] != None:
        plt.ylabel(parametres["nom_axe_y"], color=parametres["couleur_ecriture"])
    #Enregistre le fichier
    nom_fichier = "../Documents/" + parametres["titre"] + ".png"
    plt.savefig(nom_fichier, transparent=True)
    #Réinitialise le graphique pour le prochain coup
    plt.cla()

seuils = {
    "Vent" : {
        "minimum" : 0,
        "premier_seuil" : 5,
        "deuxieme_seuil" : 10,
        "maximum" : 40
    },
    "Nuage" : {
        "minimum" : -30,
        "premier_seuil" : -5,
        "deuxieme_seuil" : 0,
        "maximum" : 40
    },
    "Pluie" : {
        "minimum" : 0,
        "premier_seuil" : 1700,
        "deuxieme_seuil" : 2000,
        "maximum" : 2800
    },
    "Temperature" : {
        "minimum" : -10,
        "premier_seuil" : 0,
        "deuxieme_seuil" : 20,
        "maximum" : 40
    }
}

def lancer():
    fichier = open(nom_fichier_csv_serveur, "r")
    get_image(seuils["Vent"]["minimum"], seuils["Vent"]["premier_seuil"], seuils["Vent"]["deuxieme_seuil"], seuils["Vent"]["maximum"], 8, "Vent", fichier)
    get_image(seuils["Nuage"]["minimum"], seuils["Nuage"]["premier_seuil"], seuils["Nuage"]["deuxieme_seuil"], seuils["Nuage"]["maximum"], 3, "Nuage", fichier)
    get_image(seuils["Pluie"]["minimum"], seuils["Pluie"]["premier_seuil"], seuils["Pluie"]["deuxieme_seuil"], seuils["Pluie"]["maximum"], 5, "Pluie", fichier, inverser=True)
    get_image(seuils["Temperature"]["minimum"], seuils["Temperature"]["premier_seuil"], seuils["Temperature"]["deuxieme_seuil"], seuils["Temperature"]["maximum"], 6, "Temperature", fichier)
    fichier.close()
    print("Image : Images créées")
    ecrire_logs("Image : Images créées")
